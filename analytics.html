<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reformer Analytics Dashboard</title>
  <!-- Supabase JS v2 UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #filters { margin-bottom: 20px; }
    label { margin-right: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f0f0f0; }
    #historyChart { margin-top: 30px; max-width: 800px; }
  </style>
</head>
<body>
  <h1>Smart Reformer Analytics</h1>

  <div id="filters">
    <label>User ID: <input type="text" id="filterUser" placeholder="e.g. user123"></label>
    <label>Exercise:
      <select id="filterExercise">
        <option value="">All</option>
        <option value="row">Row</option>
        <option value="lunge">Lunge</option>
        <option value="tricep_press">Tricep Press</option>
        <option value="elephant">Elephant</option>
        <option value="short_box">Short Box</option>
      </select>
    </label>
    <button id="btnLoad">Load Data</button>
  </div>

  <table id="dataTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Session ID</th>
        <th>User ID</th>
        <th>Exercise</th>
        <th>Spring</th>
        <th>Position (cm)</th>
        <th>Force (N)</th>
        <th>Rep #</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <canvas id="historyChart"></canvas>

  <script>
    // --- Configuration ---
    const SUPABASE_URL = 'https://pqqcmczswbxkhsbqqsop.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcWNtY3pzd2J4a2hzYnFxc29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMjE0NDksImV4cCI6MjA2ODg5NzQ0OX0.DUjQqT0RpsFrRTGq2iNTEpgP7G7J_dBPcLz4U3BqKiY'; // replace with your real key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- DOM References ---
    const filterUser    = document.getElementById('filterUser');
    const filterExercise= document.getElementById('filterExercise');
    const btnLoad       = document.getElementById('btnLoad');
    const tableBody     = document.querySelector('#dataTable tbody');
    const ctxChart      = document.getElementById('historyChart').getContext('2d');
    let historyChart;

    // --- Load Handler with Debugging ---
    btnLoad.addEventListener('click', async () => {
      console.log('üîÑ Load Data clicked', { user: filterUser.value, exercise: filterExercise.value });

      // Build query
      let query = supabase.from('session_data').select('*');
      if (filterUser.value.trim()) {
        query = query.eq('user_id', filterUser.value.trim());
      }
      if (filterExercise.value) {
        query = query.eq('exercise_type', filterExercise.value);
      }
      query = query.order('timestamp', { ascending: true }).limit(500);

      // Log the generated query if possible
      if (query.toSQL) console.log('üìã Generated SQL:', query.toSQL().sql);

      // Execute
      const { data, error } = await query;
      console.log('‚úÖ Query result:', { data, error });
      if (error) return alert('Error loading data: ' + error.message);

      // Populate table
      tableBody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(row.timestamp).toLocaleString()}</td>
          <td>${row.session_id}</td>
          <td>${row.user_id}</td>
          <td>${row.exercise_type}</td>
          <td>${row.spring_setting}</td>
          <td>${row.carriage_pos}</td>
          <td>${row.force_n}</td>
          <td>${row.rep_number}</td>
        `;
        tableBody.appendChild(tr);
      });

      // Plot chart
      const labels    = data.map(r => new Date(r.timestamp).toLocaleTimeString());
      const posData   = data.map(r => r.carriage_pos);
      const forceData = data.map(r => r.force_n);

      if (historyChart) historyChart.destroy();
      historyChart = new Chart(ctxChart, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Position (cm)', data: posData, borderColor: 'blue', fill: false },
            { label: 'Force (N)',    data: forceData, borderColor: 'red',  fill: false }
          ]
        },
        options: { animation: false, scales: { x: { display: true } } }
      });
    });

    // --- Initial Debug Select Test ---
    (async () => {
      const { data, error } = await supabase.from('session_data').select('*').limit(1);
      console.log('üîç Initial select test:', { data, error });
    })();
  </script>
</body>
</html>
