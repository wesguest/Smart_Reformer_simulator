<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Reformer Analytics Dashboard</title>
  <!-- Supabase JS v2 UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #filters { margin-bottom: 20px; }
    label { margin-right: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f4f4f4; }
  </style>
</head>
<body>
  <h1>Reformer Analytics Dashboard</h1>
  
  <!-- Filter Controls -->
  <div id="filters">
    <label>User ID: <input type="text" id="filterUser" placeholder="(optional)"></label>
    <label>Exercise:
      <select id="filterExercise">
        <option value="">All</option>
        <option value="row">Row</option>
        <option value="lunge">Lunge</option>
        <option value="tricep_press">Tricep Press</option>
        <option value="elephant">Elephant</option>
        <option value="short_box">Short Box</option>
      </select>
    </label>
    <button id="btnLoad">Load Data</button>
  </div>

  <!-- Data Table -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>Session</th>
        <th>User</th>
        <th>Exercise</th>
        <th>Spring</th>
        <th>Position (cm)</th>
        <th>Force (N)</th>
        <th>Rep</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Chart -->
  <canvas id="historyChart" height="200" style="margin-top:20px; width:100%;"></canvas>

  <script>
    // --- Supabase Setup ---
    const SUPABASE_URL = 'https://pqqcmczswbxkhsbqqsop.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcWNtY3pzd2J4a2hzYnFxc29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMjE0NDksImV4cCI6MjA2ODg5NzQ0OX0.DUjQqT0RpsFrRTGq2iNTEpgP7G7J_dBPcLz4U3BqKiY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- DOM References ---
    const btnLoad        = document.getElementById('btnLoad');
    const filterUser     = document.getElementById('filterUser');
    const filterExercise = document.getElementById('filterExercise');
    const tableBody      = document.querySelector('#dataTable tbody');
    const ctx            = document.getElementById('historyChart').getContext('2d');
    let historyChart;

    // --- Load Data Handler ---
    btnLoad.addEventListener('click', async () => {
      console.log('ðŸ”„ Load Data clicked', { user: filterUser.value, exercise: filterExercise.value });

      // Build query
      let query = supabase.from('session_data').select('*');
      if (filterUser.value)     query = query.eq('user_id', filterUser.value);
      if (filterExercise.value) query = query.eq('exercise_type', filterExercise.value);
      query = query.order('timestamp', { ascending: true }).limit(500);

      // Debug: log the query object
      console.log('ðŸ“‹ Running query:', query);

      // Execute
      const { data, error } = await query;
      console.log('âœ… Query result:', { data, error });

      if (error) {
        console.error('Error loading data:', error);
        return alert('Error loading dataâ€”see console for details');
      }

      // Populate table
      tableBody.innerHTML = '';
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(row.timestamp).toLocaleString()}</td>
          <td>${row.session_id}</td>
          <td>${row.user_id}</td>
          <td>${row.exercise_type}</td>
          <td>${row.spring_setting}</td>
          <td>${row.carriage_pos}</td>
          <td>${row.force_n}</td>
          <td>${row.rep_number}</td>
        `;
        tableBody.appendChild(tr);
      });

      // Prepare chart data
      const labels = data.map(r => new Date(r.timestamp).toLocaleTimeString());
      const posData = data.map(r => r.carriage_pos);
      const forceData = data.map(r => r.force_n);

      // Render chart
      if (historyChart) historyChart.destroy();
      historyChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [
          { label: 'Position (cm)', data: posData, borderColor: 'blue', fill: false },
          { label: 'Force (N)',    data: forceData, borderColor: 'red',  fill: false }
        ]},
        options: { animation: false, scales: { x: { display: true } }}
      });
    });
  </script>
</body>
</html>
